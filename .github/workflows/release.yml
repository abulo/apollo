name: Create Release Tag
on:
  push:
    tags:
      - 'v*' # 推送标签，比如 v1.0, v20.15.10

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 获取当前和上一个标签
        id: getTags
        run: |
          git fetch --prune --unshallow
          tags=($(git tag -l --sort=-version:refname))
          currentTag=${tags[0]}
          previousTag=${tags[1]}
          echo "::set-output name=currentTag::$currentTag"
          echo "::set-output name=previousTag::$previousTag"

      - name: 提取并分类提交消息
        id: extractCommitMessages
        run: |
          set -e
          currentTag="${{ steps.getTags.outputs.currentTag }}"
          previousTag="${{ steps.getTags.outputs.previousTag }}"
          commitMessages=$(git log --pretty=format:"%s %h" "$previousTag".."$currentTag" | grep -E 'feat|fix|docs|perf')
          featMessages=$(echo "$commitMessages" | grep 'feat' || true)
          fixMessages=$(echo "$commitMessages" | grep 'fix' || true)
          docsMessages=$(echo "$commitMessages" | grep 'docs' || true)
          perfMessages=$(echo "$commitMessages" | grep 'perf' || true)
          echo "::set-output name=featMessages::${featMessages[@]}"
          echo "::set-output name=fixMessages::${fixMessages[@]}"
          echo "::set-output name=docsMessages::${docsMessages[@]}"
          echo "::set-output name=perfMessages::${perfMessages[@]}"

      - name: 获取当前分支名
        id: getBranchName
        run: |
          branchName=$(git rev-parse --abbrev-ref HEAD)
          echo "::set-output name=branchName::$branchName"

      - name: 发布说明
        id: generateReleaseNotes
        run: |
            # 提取提交消息分类
            featMessages=("${{ steps.extractCommitMessages.outputs.featMessages }}")
            fixMessages=("${{ steps.extractCommitMessages.outputs.fixMessages }}")
            docsMessages=("${{ steps.extractCommitMessages.outputs.docsMessages }}")
            perfMessages=("${{ steps.extractCommitMessages.outputs.perfMessages }}")
            # 生成发布说明的Markdown字符串
            releaseNotes="> ## 更新内容：  \n"
            if [[ -n "$featMessages" ]]; then
              releaseNotes="$releaseNotes\n### ✨ Features | 新功能:  \n"
              for message in "${featMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            if [[ -n "$fixMessages" ]]; then
              releaseNotes="$releaseNotes\n### 🐛 Bug Fixes | Bug 修复:  \n"
              for message in "${fixMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            if [[ -n "$docsMessages" ]]; then
              releaseNotes="$releaseNotes\n### ✏️ Documentation | 文档:  \n"
              for message in "${docsMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            if [[ -n "$perfMessages" ]]; then
              releaseNotes="$releaseNotes\n### ⚡ Performance Improvements | 性能优化:  \n"
              for message in "${perfMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            echo "::set-output name=releaseNotes::$releaseNotes"

      - name: 写入生成的发布说明到 changelog.md
        run: |
              echo -e "${{ steps.generateReleaseNotes.outputs.releaseNotes }}" > changelog.md
              cat changelog.md

      - name: 测试
        run: cat changelog.md

      - name: 发布
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: changelog.md