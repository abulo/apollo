name: Create Release Tag
on:
  push:
    tags:
      - 'v*' # æ¨é€æ ‡ç­¾ï¼Œæ¯”å¦‚ v1.0, v20.15.10
jobs:
  build:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å½“å‰å’Œä¸Šä¸€ä¸ªæ ‡ç­¾
        id: getTags
        run: |
          git fetch --prune --unshallow
          tags=($(git tag -l --sort=-version:refname))
          currentTag=${tags[0]}
          previousTag=${tags[1]}
          echo "currentTag=$currentTag" >> $GITHUB_ENV
          echo "previousTag=$previousTag" >> $GITHUB_ENV

      - name: æå–å¹¶åˆ†ç±»æäº¤æ¶ˆæ¯
        id: extractCommitMessages
        run: |
          set -e
          currentTag="${{ env.currentTag }}"
          previousTag="${{ env.previousTag }}"
          commitMessages=$(git log --pretty=format:"%s %h" "$previousTag".."$currentTag" | grep -E 'feat|fix|docs|perf')
          featMessages=$(echo "$commitMessages" | grep 'feat' || true)
          fixMessages=$(echo "$commitMessages" | grep 'fix' || true)
          docsMessages=$(echo "$commitMessages" | grep 'docs' || true)
          perfMessages=$(echo "$commitMessages" | grep 'perf' || true)
          echo "$featMessages" > featMessages.txt
          echo "$fixMessages" > fixMessages.txt
          echo "$docsMessages" > docsMessages.txt
          echo "$perfMessages" > perfMessages.txt
          echo "featMessages=$(cat featMessages.txt)" >> $GITHUB_ENV
          echo "fixMessages=$(cat fixMessages.txt)" >> $GITHUB_ENV
          echo "docsMessages=$(cat docsMessages.txt)" >> $GITHUB_ENV
          echo "perfMessages=$(cat perfMessages.txt)" >> $GITHUB_ENV

      - name: è·å–å½“å‰åˆ†æ”¯å
        id: getBranchName
        run: |
          branchName=$(git rev-parse --abbrev-ref HEAD)
          echo "branchName=$branchName" >> $GITHUB_ENV

      - name: å‘å¸ƒè¯´æ˜
        id: generateReleaseNotes
        run: |
            # æå–æäº¤æ¶ˆæ¯åˆ†ç±»
            featMessages="${{ env.featMessages }}"
            fixMessages="${{ env.fixMessages }}"
            docsMessages="${{ env.docsMessages }}"
            perfMessages="${{ env.perfMessages }}"
            # ç”Ÿæˆå‘å¸ƒè¯´æ˜çš„Markdownå­—ç¬¦ä¸²
            releaseNotes="## æ›´æ–°å†…å®¹ï¼š  \n"
            if [[ -n "$featMessages" ]]; then
              releaseNotes="$releaseNotes\n### âœ¨ Features | æ–°åŠŸèƒ½:  \n"
              for message in "${featMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            if [[ -n "$fixMessages" ]]; then
              releaseNotes="$releaseNotes\n### ğŸ› Bug Fixes | Bug ä¿®å¤:  \n"
              for message in "${fixMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            if [[ -n "$docsMessages" ]]; then
              releaseNotes="$releaseNotes\n### âœï¸ Documentation | æ–‡æ¡£:  \n"
              for message in "${docsMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            if [[ -n "$perfMessages" ]]; then
              releaseNotes="$releaseNotes\n### âš¡ Performance Improvements | æ€§èƒ½ä¼˜åŒ–:  \n"
              for message in "${perfMessages[@]}"; do
                releaseNotes="$releaseNotes\n- $message"
              done
            fi
            echo "$releaseNotes" > releaseNotes.txt
            echo "releaseNotes=$(cat releaseNotes.txt)" >> $GITHUB_ENV

      - name: å†™å…¥ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜åˆ° changelog.md
        run: |
              echo -e "${{ env.releaseNotes }}" > changelog.md
              cat changelog.md

      - name: åˆ›å»ºæ ‡ç­¾çš„å‘å¸ƒ
        id: releaseTag
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: "false"  # ç¦ç”¨è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
          bodyfile: changelog.md
